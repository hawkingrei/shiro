# TODO

This file tracks current tasks and should stay aligned with `docs/notes/follow-ups.md` to avoid stale plans.
Latest sync: added optional TiFlash replica readiness wait for MPP flows (2026-02-26): introduced `oracles.mpp_tiflash_wait_seconds`; after applying `ALTER TABLE ... SET TIFLASH REPLICA <n>`, runner can poll `information_schema.tiflash_replica` until `AVAILABLE=1` or timeout. Added helper coverage in `internal/runner/runner_utils_test.go`, config coverage in `internal/config/config_test.go`, and updated README/config docs. Validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp go test ./internal/config ./internal/runner`.
Latest sync: added TiFlash replica provisioning for MPP exploration (2026-02-26): introduced `oracles.mpp_tiflash_replica` and runner-side hooks that apply `ALTER TABLE ... SET TIFLASH REPLICA <n>` after successful base-table creation (initial state, DSG init, and runtime `create_table`); added helper coverage in `internal/runner/runner_utils_test.go`, config coverage in `internal/config/config_test.go`, and updated README/config docs. Validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp go test ./internal/config ./internal/runner`.
Latest sync: added TiDB MPP hint coverage for DQP (2026-02-26): DQP built-in `SET_VAR` candidates now include `tidb_allow_mpp=ON/OFF` when join paths exist, so plan-differential runs can sample MPP-enabled and MPP-disabled optimizer behavior; added regression tests in `internal/oracle/dqp_test.go` and validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp go test ./internal/oracle`.
Latest sync: refreshed config baselines (2026-02-22): expanded `config.example.yaml` into a complete, secret-free reference config aligned with code defaults, switched `defaultConfig()` to `qpg.enabled=true`, and lowered default view cap to `view_max=3` for tighter schema/view churn control; added default assertion in `internal/config/config_test.go` and validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp go test ./internal/...`.
Latest sync: added configurable CODDTest CASE branch cap (2026-02-24): introduced `oracles.coddtest_case_when_max` (default `20`) and enforced it in dependent CASE rewrite generation to prevent overly long `WHEN` chains; added config/oracle regression tests and README/config updates.
Latest sync: filed TiDB compatibility issue #66345 for `case_0003_019c8e4e-4d8c-7e70-bf1e-8f5f22bd29d3` (2026-02-24): reported CODDTest rewritten CASE predicate divergence (TiDB returns 0 rows while MySQL reports `1525 Incorrect DATETIME value: '99.55'`), with issue body formatted per project guidance and schema/data SQL collapsed in `<details>`.
Latest sync: completed report taxonomy ownership normalization (2026-02-22): `internal/runner/runner_errors.go` now applies runner-side canonical reason ownership beyond the PQS runtime-1105 special case by overriding oracle-pre-filled generic `*:sql_error[_code]` reasons only when runner classification is more specific (while preserving non-generic oracle reasons), and keeps forced canonical runtime-1105 behavior. Added regression tests in `internal/runner/runner_errors_test.go`; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner`.
Latest sync: fixed PQS runtime-1105 report canonicalization (2026-02-22): `internal/runner/runner_errors.go` now forces `error_reason=pqs:runtime_1105` + `bug_hint=tidb:runtime_error` for runtime index-out-of-range errors even when oracle details pre-fill `pqs:sql_error_1105`, preventing report taxonomy drift; added regression tests in `internal/runner/runner_errors_test.go` and validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner`.
Latest sync: drafted syntax-expansion design ADR `docs/decisions/2026-02-22-adaptive-syntax-capability-pipeline.md` (2026-02-22): defined a staged capability-registry + gate-evaluation rollout plan and documented a taxonomy consistency gap where oracle-pre-filled `pqs:sql_error_1105` can bypass runner canonicalization to `pqs:runtime_1105`; next step is a focused runner/oracle classification ownership fix with regression coverage.
Latest sync: addressed PR #132 review follow-ups for plan-cache table candidate filtering (2026-02-22): `internal/generator/generator_prepared.go` now reuses `schema.State.BaseTables()` in both `preparedCandidateTables` (when `plan_cache_only` is enabled) and `nonPreparedCandidateTables`, removing redundant view-filter loops and allocations while preserving behavior. Validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/generator` and `... go test ./internal/runner`.
Latest sync: strengthened QPG mutate handling for view-heavy schemas (2026-02-22): runner QPG mutate now uses base tables for direct index/analyze actions, and when only views are present it resolves dependent base tables via `information_schema.VIEW_TABLE_USAGE` + `TABLES` (`BASE TABLE` filter) and samples bounded fallback analyze candidates to avoid `ANALYZE TABLE <view>` failures. Added regression tests in `internal/runner/runner_qpg_test.go`; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner`.
Latest sync: adjusted P0 runtime-1105 policy to preserve runtime bug signal (2026-02-21): `error_reason=pqs:runtime_1105` now keeps `bug_hint=tidb:runtime_error` regardless of minimize status, and uses metadata-only reproducibility annotations (`runtime_bug_reproducible`, `runtime_bug_hint_gated`, `runtime_bug_hint_gate_reason`) so triage can separate repro-backed vs non-repro runtime samples without dropping signal. Updated `internal/runner/runner_report_test.go`, README, and triage notes; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner`.
Latest sync: expanded P0 runtime-1105 reproducibility gate coverage and docs (2026-02-21): added `disabled`/`not_applicable` regression tests for `applyRuntime1105ReproGate` (including preservation of pre-filled `runtime_bug_hint_gate_reason`) and documented runtime gate behavior in README (`runtime_bug_hint_gated`, `runtime_bug_hint_gate_reason`). Validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner`.
Latest sync: completed P0 runtime-1105 reproducibility gate (2026-02-19): runner now gates `bug_hint=tidb:runtime_error` for `error_reason=pqs:runtime_1105` by minimize reproducibility status, keeping the runtime bug channel only when `minimize_status=success`; unreproducible/disabled/not-applicable paths clear the runtime bug hint and mark `runtime_bug_hint_gated=true` in details for auditability. Added regression tests in `internal/runner/runner_report_test.go`; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner`.
Latest sync: closed the P0 PQS runtime-1105 triage follow-up (2026-02-19): added `docs/notes/pqs-runtime-1105-triage.md` with evidence and reopen criteria; decision is to keep `pqs:runtime_1105` + `bug_hint=tidb:runtime_error` classification and defer upstream issue filing until a reproducible sample appears.
Latest sync: started P0 PQS runtime-1105 triage hardening (2026-02-19): runner now classifies `PQS` MySQL `1105` errors with `index out of range` as `pqs:runtime_1105` (instead of generic `pqs:sql_error_1105`) with `bug_hint=tidb:runtime_error`, improving report-side aggregation for reproducibility triage; timeout MySQL code checks in runner errors were also switched to named constants. Added regression tests in `internal/runner/runner_errors_test.go`; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner`.
Latest sync: fixed `revive` `confusing-results` lint findings in `internal/oracle/dqp.go` by using named return values for bool helpers (`dqpExprConstBool`, `dqpLiteralAsBool`), with no behavior change; validated via `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/oracle` (2026-02-19).
Latest sync: continued throughput algorithm hardening (2026-02-19): added infra-aware throughput control (`infraUnhealthyTTL`) driven by runtime/report errors (`region_unavailable`, `schema_out_of_date`, `tikv_connectivity`) so oracle scheduling can degrade predictably during DB unhealthy windows; oracle weights now apply infra-aware caps (`DQP`/`GroundTruth` disabled, `TLP`/`DQE` capped), oracle-bandit batch rewards now penalize timeout/infra-heavy windows, and per-oracle timeout now uses stricter cap under infra unhealthy state (`infraOracleTimeoutCapMs=3000`). Interval metrics now expose `infra_unhealthy`, `infra_ttl`, and `infra_error_reasons` to avoid treating low-sample `1/1` windows as healthy. Added/updated tests in `internal/runner/runner_throughput_guard_test.go`, `internal/runner/runner_errors_test.go`, and `internal/runner/runner_bandit_reward_test.go`; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner`.
Latest sync: continued logs/reports throughput follow-up (2026-02-19): GroundTruth edge arbitration now prefers all-inner edge sets when key completeness is not worse, reducing `groundtruth:join_type` skip blowups from SQL-edge selection drift; NoREC/TLP profiles now disable `NaturalJoins` to suppress NATURAL-join-qualified-column `sql_error_1054` noise observed in interval logs/cases. Added regression tests in `internal/oracle/groundtruth_oracle_test.go` and `internal/runner/runner_oracle_overrides_test.go`; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/oracle`, `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner`, and short `go run ./cmd/shiro -config config.yaml` smoke runs.
Latest sync: completed verification run for the latest DQP tuning (2026-02-19): re-ran `./internal/config`, `./internal/oracle`, and `./internal/runner` (Go 1.25.7 with temp cache dirs), then executed a short `go run ./cmd/shiro -config config.yaml` smoke run. Latest observed interval remained stable with `sql_valid/total=5665/5665`, DQP `run/66 eff/64 skip/2 err/0`, and DQP skips only `dqp:scope_invalid` in that window.
Latest sync: continued DQP runtime-coverage tuning (2026-02-19): DQP hint pick limits are now config-driven (`oracles.dqp_base_hint_pick_limit`, `oracles.dqp_set_var_hint_pick_max`) with local `config.yaml` raised to `6/8` for broader runtime plan-variant exploration; DQP profile now also disables `NaturalJoins` to avoid NATURAL-join scope-induced `sql_error_1054` noise seen in short runs. Added/updated tests in `internal/config/config_test.go`, `internal/oracle/dqp_test.go`, and `internal/runner/runner_oracle_overrides_test.go`; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/config ./internal/oracle ./internal/runner` plus repeated short `go run ./cmd/shiro -config config.yaml` checks.
Latest sync: continued GroundTruth throughput tuning (2026-02-19): lowered `groundtruth:join_type` skip noise by filtering non-inner join edges during GroundTruth query picking and retrying candidates, and added GroundTruth-specific join-width cap (`max_join_tables=4`) in oracle overrides to reduce wide-join skip pressure. Added regression tests in `internal/oracle/groundtruth_oracle_test.go` and `internal/runner/runner_oracle_overrides_test.go`; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner ./internal/oracle ./internal/generator`.
Latest sync: tuned DQP runtime hint sampling upward (2026-02-19): increased base hint pick limit from 2 to 3 and set-var pick range from `0..2` to `0..3` so each DQP execution explores slightly more plan variants without a large runtime jump; updated DQP tests to match the new limits. Validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/oracle -run "TestDQPSetVarHintsCount|TestDQPHintsForQueryCount|TestDQP.*"` and `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner ./internal/oracle ./internal/generator`.
Latest sync: continued throughput follow-up focused on EET skip quality (2026-02-19): reduced `eet:non_select` noise by banning set operations in EET profile/constraints (`SetOperations=false`, `DisallowSetOps`) and mapping set-op constraints/AST set-op parsing to explicit `eet:set_ops`; this avoids spending retries on non-rewritable set-op shapes while keeping skip taxonomy clearer. Added regression tests in `internal/oracle/eet_test.go` and `internal/runner/runner_oracle_overrides_test.go`; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner ./internal/oracle ./internal/generator`.
Latest sync: continued throughput-focused P1/P2 follow-up (2026-02-19): reduced DQP complexity-guard churn by forcing simpler DQP generation (profile-level `derived_tables=false`, `set_operations=false`, `join_on_policy=simple` plus builder-level `DisallowSetOps` and `MaxJoinCount=3`), and improved GroundTruth pick efficiency by retry-filtering non-inner join candidates before execution (`groundTruthHasOnlyInnerJoins`) so unsupported join-shape skips are less likely to dominate a window. Added/updated tests in `internal/oracle` and `internal/runner`; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner ./internal/oracle ./internal/generator`.
Latest sync: continued throughput hardening for low-sample intervals (2026-02-19): added runner-side low-sample throughput guard (`minSQLTotalPerInterval=200`) with streak-triggered TTL and auto-recovery, DQP timeout cooldown gating during oracle pick, DQP-specific timeout cap (`dqpOracleTimeoutCapMs=5000`), and richer interval diagnostics (`qps`, low-sample/guard/cooldown state, timeout reason deltas, `inflight_minimize`, `stalled_reason`). While guard is active, oracle overrides now temporarily disable heavy generation features (set ops, derived tables, quantified subqueries, window funcs/frames) and cap `max_join_tables` to reduce interval starvation. Added runner tests for guard/cooldown/timeout-cap/override throttling; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner ./internal/oracle ./internal/generator`.
Latest sync: continued logs/reports follow-up for P0/P1/P2 (2026-02-18): downgraded DQP timeout results to skip classification in runner (`skip_reason=dqp:timeout`) for timeout-like errors (`context deadline exceeded`, MySQL timeout/interrupted codes 1317/3024), broadened GroundTruth DSG fallback eligibility to include `base_table` and increased DSG fallback retries to 12, and kept full-join 2-table candidate shaping active in DSG mode to improve `full_join_emulation` sampling. Added regression tests in `internal/runner`, `internal/oracle`, and `internal/generator`; validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner ./internal/oracle ./internal/generator`.
Latest sync: completed logs/reports follow-up batch (2026-02-18): EET now skips unstable rank-window signatures (`skip_reason=eet:window_rank_unstable_order`) when rank windows have empty/constant ordering or partition-only ordering, reducing nondeterministic false captures; GroundTruth now prefers DSG-valid edge sets during edge-source arbitration and allows bounded non-DSG fallback picking when strict DSG fails on `right_key` mismatch; PQS pivot sampling now performs a shuffled table-scan fallback before returning `pqs:no_rows`. Added regression tests in `internal/oracle` and validated with `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/oracle` and `GOCACHE=/tmp/shiro-gocache GOTMPDIR=/tmp/shiro-gotmp /Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner -run 'TestCollectGroundTruthDSGMismatchReasons|TestGroundTruthDSGMismatchReasonFromDetails|TestAnnotateResultForReportingGroundTruthMismatch'`.
Latest sync: completed fuzz follow-up batch for logs/reports review (2026-02-17): downgraded `missing_column` false positives for EET/Impo/PQS from bug-capture to skip classification in runner (`skip_reason=<oracle>:missing_column`), improved GroundTruth DSG edge selection by preferring DSG-valid edge sets before missing-key scoring and raised pick retries to 16, stabilized TQS mode switching by clearing detached TQS walker/history state and resetting TQS delta baselines on history rewind, and added a full-join-emulation candidate path that occasionally preserves 2-table joins when emulation is enabled; added/updated regression tests in `internal/runner`, `internal/oracle`, and `internal/generator`, validated with `/Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/generator`, `/Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/oracle`, and `/Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner` using `GOCACHE=/tmp/shiro-gocache` and `GOTMPDIR=/tmp/shiro-gotmp`.
Latest sync: completed Generator/Oracles grouping-mode extension (2026-02-17): added `GROUP BY CUBE (...)` and `GROUP BY GROUPING SETS (...)` SQL builder support, introduced config flags `features.group_by_cube` and `features.group_by_grouping_sets`, centralized group-by extension selection/fallback in generator, and wired profile-based fallback by disabling CUBE/GROUPING SETS in CERT/EET profiles while keeping rollup/plain paths; added generator SQL build tests plus config/runner override tests, validated with `/Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/config`, `/Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/generator`, and `/Users/weizhenwang/.gvm/gos/go1.25.7/bin/go test ./internal/runner` using `GOCACHE=/tmp/shiro-gocache` and `GOTMPDIR=/tmp/shiro-gotmp`.
Latest sync: implemented fuzz optimization batch (2026-02-16): fixed DSG join-key offset alignment (`tN -> k(N-1)`) in generator/oracle checks to reduce GroundTruth `dsg_key_mismatch_right_key` skips, added DQP hint reward/replay context improvements (`replay_set_var` extraction for `SET_VAR(...)`), added EET no-transform retry selection (`eetTransformRetryMax=3`), and tightened minimize base replay precheck to 2-of-3 consensus; validated with `go test ./internal/generator -run 'TestDSGAllowedJoinKeyTableOffset'`, `go test ./internal/oracle -run 'TestDQPHintReward|TestDQPReplaySetVarAssignment|TestEETShouldRetryNoTransform|TestDSGTableKeyName|TestGroundTruthDSGSkipReason|TestGroundTruthDSGPrecheck|TestGroundTruthDSGRightKeysAvailable'`, and `go test ./internal/runner -run 'TestReplayConsensus|TestOracleBanditImmediateReward'` using a Go 1.25.6-compatible toolchain with `GOCACHE=/tmp/shiro-gocache` and `GOTMPDIR=/tmp/shiro-gotmp`.
Latest sync: addressed PR #116 review feedback for DQP external hints by filtering unsafe `*/` inputs, preventing malformed `SET_VAR(...)` from falling back into base hints, adding regression tests for unsafe/malformed hint handling plus `normalizeSetVarHint` classification, and aligning noted Go version to 1.25.6 for go.mod consistency; verified with `go test ./internal/oracle`, `go test ./internal/config`, and `go test ./cmd/shiro` (2026-02-15).
Latest sync: added DQP support for `SET_VAR(tidb_opt_partial_ordered_index_for_topn='COST'|'DISABLE')`, introduced config-driven external DQP hint injection via `oracles.dqp_external_hints` (supports full hints and raw `var=value` SET_VAR shorthand), and documented usage in README; added oracle/config regression tests and verified with `go test ./internal/oracle`, `go test ./internal/config`, and `go test ./cmd/shiro` using Go 1.25.6 (2026-02-15).
Latest sync: addressed PR #113 review feedback for CI run-info ingestion by splitting the startup run-info format string for readability, fixing `SHIRO_CI` override edge cases (ignore empty explicit `SHIRO_CI`, preserve explicit `SHIRO_CI=false` while allowing other `SHIRO_CI_*` fields), and ensuring `SHIRO_CI=true` alone is retained as non-zero metadata; added regression tests in `internal/runinfo/basic_info_test.go`, verified with `go test ./internal/runinfo` and `go test ./cmd/shiro` (using unset `GOROOT` and temp `GOCACHE`) (2026-02-15).
Latest sync: made Worker metadata reads public (no API token required for list/get/search/similar) while keeping sync/patch writes token-protected, and added report UI issue filters (`All issues` and `Only linked issue`) so tag/issue triage and issue-only bug views work without token input; validated via `npm run compile`, `npm run lint`, `npm run test:worker`, and `npm test` under `web/` (2026-02-15).
Latest sync: addressed PR #115 review follow-ups in report UI metadata caching by preventing cache hydration from clobbering worker-loaded/in-flight state, enforcing Worker->embedded->cache resolution precedence, memoizing no-token `401` metadata fetches to avoid repeat retries, and reducing cache write amplification by skipping unchanged canonical payload writes with a debounce; also added non-production cache diagnostics; validated via `npm run compile`, `npm run lint`, and `npm test` under `web/` (2026-02-15).
Latest sync: report UI now resolves labels/issues from Worker metadata with embedded/cache fallback so tags/issues remain visible without entering a write token, and case detail now renders Min Repro SQL from `replay_sql` with minimize status context when available; validated via `npm run compile`, `npm run lint`, and `npm test` under `web/` (2026-02-15).
Latest sync: fixed PR #114 CI lint regression by deleting stale unreferenced feature-detection helpers in `internal/generator/features.go` (left after the single-pass `AnalyzeQueryFeatures` refactor); verified with local `golangci-lint run --timeout=5m` plus targeted generator/runner tests (2026-02-15).
Latest sync: addressed PR #114 review follow-ups by reducing `AnalyzeQueryFeatures` redundant traversals via a primary single-pass walk, centralizing template strategy normalization in generator (reused by runner), and removing duplicate template-weight normalization from generator fallback logic; updated generator/runner tests accordingly (2026-02-15).
Latest sync: reviewed latest local `logs/shiro.log` + `reports/*/summary.json` (2026-02-15): 17 captured cases (16 `skipped`, 1 `not_applicable`), all skipped cases had `minimize_reason=base_replay_not_reproducible`; GroundTruth remained skip-dominant with DSG mismatch reasons (`base_table`/`right_key`), while DQP stayed effective and template strategy counters (`join_filter`/`join_only`) were both active.
Latest sync: documented the GitHub Actions GCS-secret-to-`storage.s3.*` mapping (including `AWS_*` credential-chain usage) in `README.md` (2026-02-14).
Latest sync: added CI runtime metadata ingestion from environment (`SHIRO_CI_*` with provider fallback), wired it into case `summary.json`/`report.json` as `run_info`, and mapped GitHub Actions CI env defaults in `.github/workflows/ci.yaml` (2026-02-14).
Latest sync: GroundTruth now auto-aligns effective `maxRows` with TQS `wide_rows` in DSG mode (while still honoring baseline config floors), reducing `groundtruth:table_rows_exceeded` skips caused by cap mismatch; added regression coverage (2026-02-14).
Latest sync: added runner-level QPG tests for threshold-triggered adaptive overrides and TTL-based override retirement, plus a CI-focused QPG config snippet in README (2026-02-14).
Latest sync: centralized non-template QPG adaptive thresholds and override TTL into config (`qpg.no_*_threshold`, `qpg.override_ttl`), and updated runner QPG weight-override logic to consume config-driven values with normalization defaults (2026-02-14).
Latest sync: centralized QPG template-override tuning into config (`qpg.template_override`) with defaults/normalization for thresholds, boost weights, enabled probability, and TTL; runner now reads these config values instead of hard-coded constants (2026-02-14).
Latest sync: completed observability rollout for `set_operations` / `derived_tables` / `quantified_subqueries`: QueryFeatures now detects these flags across nested subqueries/CTEs, runner interval logs expose per-interval counts/ratios, and generator/runner regression tests were added (2026-02-14).
Latest sync: added generator observability for `window_frame` and `interval_arith` features (feature detection + runner interval counters/ratios), with regression tests for QueryFeatures and runner stats accounting (2026-02-14).
Latest sync: strengthened CERT build-time guardrails by disallowing aggregate/distinct/group-by/having/order-by/set-op/window shapes (to avoid `ONLY_FULL_GROUP_BY`/ordering-related noise), and tightened TLP/DQP predicate shaping to simple-column mode so predicate-guard skips are reduced without relaxing semantic checks; added regression tests (2026-02-14).
Latest sync: split template join-predicate shaping into explicit `join_only` vs `join_filter` strategies with configurable feature weights (`template_join_only_weight` / `template_join_filter_weight`) and interval observability; GroundTruth now uses a shared edge-building path that prefers SQL AST extraction when it provides equal/better key coverage, and both pick/run paths are wired through it with regression tests (2026-02-14).
Latest sync: reviewed fresh local logs/reports after oracle fixes (2026-02-14): DQP showed no `sql_error_1054` and stayed effective, EET `no_transform` skip dropped in the DQE interval, but GroundTruth remained skip-dominant (`dsg_key_mismatch_right_key`/`base_table`) with effective ratio 0 and captured cases still minimized as non-reproducible.
Latest sync: completed follow-ups from the 2026-02-14 logs/reports review: GroundTruth now adds DSG prechecks + right-key availability checks with higher pick retries, EET now falls back across rewrite kinds to reduce `no_transform`, and DQP now skips invalid-scope queries (`dqp:scope_invalid`) with NATURAL RIGHT JOIN scope regression coverage (2026-02-14).
Latest sync: reviewed local `logs/shiro.log` + `reports/case_*/summary.json` (2026-02-14): GroundTruth effective ratio repeatedly dropped to 0 due to `dsg_key_mismatch_right_key`/`empty_query`; EET skips were dominated by `eet:no_transform`; recent captured cases were mostly non-reproducible during minimize (`base_replay_not_reproducible`).
Latest sync: addressed PR #110 follow-up review findings by sanitizing dot-segment case path components, preferring local case summary URLs when case IDs are present, and treating empty `details` objects as not detail-loaded in frontend normalization (2026-02-13).
Latest sync: addressed PR #110 review threads by aligning search-blob empty-details handling, adding abort/race safety for on-demand case detail fetches, and preventing unresolved-summary lazy-load attempts via `detail_loaded=true` fallback in index entries (2026-02-13).
Latest sync: completed report index + on-demand detail loading (P1): shiro-report now writes `reports.index.json` and per-case `cases/<case_id>/summary.json`, publish uploads include index+case summaries, and UI loads index first with lazy `summary_url` fetch plus legacy manifest fallback (2026-02-13).
Latest sync: addressed PR #109 review follow-ups in report UI (simplified case render key, cleaned search-blob construction, fixed disabled button hover behavior, and added pagination aria-labels) (2026-02-13).
Latest sync: improved report UI query efficiency (P0) with debounced+deferred keyword search, prebuilt per-case search blobs, pagination (30 cases/page), and lazy rendering of heavy case body sections only after row expansion (2026-02-13).
Latest sync: addressed PR #108 review follow-ups for metadata bootstrap robustness (safe async error handling, complete-only missing-case loaded marking, draft-edit preservation during merge, narrowed effect dependencies via refs, and shared auth-header usage for PATCH) (2026-02-13).
Latest sync: report UI now bootstraps case metadata on load from Worker `/api/v1/cases` (with token-auth headers) so saved tags/issues remain visible after refresh; similar-case in-page fetch now includes auth headers as well (2026-02-13).
Latest sync: fixed Cloudflare Git deploy D1 binding drift by adding root `wrangler.jsonc` DB binding, aligning worker `wrangler.jsonc` binding name to `DB`, and documenting that root config must include runtime bindings to prevent post-deploy binding loss (2026-02-13).
Latest sync: added Worker 500 logging with request_id for debugging (2026-02-12).
Latest sync: improved logs/reports diagnostics (PQS error stage/sql fields, USING-id projection dedup, EET runtime DISTINCT+ORDER BY skip classification, and startup recovery of stale minimize in_progress -> interrupted) with tests (2026-02-12).
Latest sync: allow tag/issue saves even when metadata is not preloaded (2026-02-12).
Latest sync: treat metadata 404 as empty meta in the UI (2026-02-12).
Latest sync: secured worker list/search/similar behind read auth, documented metadata-only similarity/search, and enabled observability flag (2026-02-12).
Latest sync: trimmed Worker D1 schema to case_id/labels/linked_issue, removed download endpoint, and UI uses archive URLs for downloads (2026-02-12).
Latest sync: secured metadata GET with auth when API token is set, narrowed payloads, and store tokens in session storage (2026-02-12).
Latest sync: removed the waterfall view selector from the report UI (2026-02-11).
Latest sync: moved worker write-token input to a Settings panel in the report UI (2026-02-11).
Latest sync: worker metadata GET and UI tagging/issue linking via token-authenticated PATCH (2026-02-11).
Latest sync: report UI orders case detail sections as error, schema.sql, data.tsv, then case.sql (2026-02-11).
Latest sync: report UI hides Expected/Actual blocks independently when their text is empty (2026-02-11).
Latest sync: report UI removes the Open report.json action from the toolbar (2026-02-11).
Latest sync: report UI maps `gs://` artifact locations to public GCS URLs for downloads (2026-02-11).
Latest sync: report UI hides `case.tar.zst` content and uses a single download-case action per bug (2026-02-11).
Latest sync: simplified USING ambiguity checks to reuse a single left-side column scan (2026-02-11).
Latest sync: guarded USING joins against ambiguous left-side columns and added generator regression coverage (2026-02-11).
Latest sync: fixed PQS USING-id select qualification, added richer case log fields, and stabilized QPG delta logging (2026-02-11).
Latest sync: clarified recursive CTE feature semantics and refactored generator interval log format strings (2026-02-11).
Latest sync: switched tests to load `config.example.yaml` and added the example config file (2026-02-11).
Latest sync: added generator feature counters for natural joins, full join emulation, and recursive CTEs with tests (2026-02-11).
Latest sync: added GCS artifact storage support with gs:// URL mapping while keeping R2 publish flow and legacy S3 compatibility (2026-02-10).
Latest sync: completed PQS v2/v3 (join-aware JOIN ON, subquery predicates, derived tables) and refreshed PQS TODOs (2026-02-09).
Latest sync: added DQP SET_VAR hints for tidb_enable_outer_join_reorder and tidb_enable_inl_join_inner_multi_pattern (2026-02-09).
Latest sync: addressed PQS review feedback (bool literal consistency, row error checks, preallocations, doc status) (2026-02-09).
Latest sync: fixed PQS lints for errcheck (rows.Close) and revive confusing-results (2026-02-09).
Latest sync: aligned TODO with follow-ups after PQS float-guard work (2026-02-09).
Latest sync: deduplicated CODDTest CASE conditions to reduce oversized dependent predicates (2026-02-09).
Latest sync: ensured PQS pivot row fetch checks rows.Err to avoid silent skips (2026-02-09).
Latest sync: stripped database qualifiers from dumped CREATE VIEW statements in reports (2026-02-09).
Latest sync: added NATURAL JOIN guard to avoid ambiguous columns in generated SQL (2026-02-09).
Latest sync: documented TiDB issue formatting guidance (collapse schema/load data details, format run query SQL) (2026-02-09).
Latest sync: added Cloudflare Worker assets stub and wrangler config for Git-integrated deploys (2026-02-10).
Latest sync: added root `wrangler.jsonc` so `wrangler versions upload` locates the worker entrypoint/assets (2026-02-10).
Last review: 2026-02-07. Added broader SQL2023 regression coverage (recursive CTE guards, FULL JOIN emulation edge cases, window determinism/named-window overrides, GROUPING ordinal unwrap), oracle SQL helper fast-path/build tests, TiDB-compat regressions to keep `INTERSECT ALL`/`EXCEPT ALL` disabled, nil-operand hardening for expression determinism/build paths, runner-side `error_reason/bug_hint` classification for PlanCache and GroundTruth mismatch reporting, P1 batch-1 skip-reduction overrides for GroundTruth/CODDTest, systemic NoREC constraint tightening via builder-level set-op disallow + query guard reasons, scope-manager enforcement for `USING` qualified-column visibility with regression tests, NATURAL JOIN column-visibility enforcement, set-op ORDER/LIMIT normalization, inline-subquery `WITH` guard unification, canonical `plan_reference_missing` bug-hint alignment, GroundTruth DSG mismatch reason taxonomy with retry-on-mismatch picking, GroundTruth USING-to-ON rewrite for ambiguity reduction, CODDTest build-time null/type prechecks, EET/TLP signature prechecks for invalid ORDER BY ordinals and known-table column visibility, EET distinct-order/scope pre-guards, top-level interval aggregation for `groundtruth_dsg_mismatch_reason`, summary/index top-level propagation of `groundtruth_dsg_mismatch_reason`, builder retry tuning for constrained oracles, GroundTruth/Impo retry-on-invalid-seed behavior, and summary-level `minimize_status` with interrupted fallback.
Latest sync: skipped float/double columns when building PQS predicates to avoid exact-float false positives (2026-02-09).
Latest sync: added a PQS predicate-strategy bandit (rectify-random vs pivot-single/multi) with bandit metadata and predicate-range tests (2026-02-09).
Latest sync: added a minimal PQS 3VL evaluator/rectifier with predicate rectification metadata and fallback reasons (2026-02-08).
Latest sync: optimized PQS containment queries to match only `id` columns when available, reducing SQL size (2026-02-08).
Latest sync: reviewed a PQS-focused run: 20 PQS cases (18 join, 1 single-table, 1 error), with one TiDB runtime error (`Error 1105: index out of range`) that was non-reproducible in minimize (2026-02-09).
Latest sync: added a PQS join containment SQL integration test for basic two-table pivots (2026-02-08).
Latest sync: cleaned `docs/roadmap.md` completed items, reorganized the roadmap by stages, and synced `docs/todo.md` with `docs/notes/follow-ups.md` (2026-02-08).
Latest sync: moved completed Impo roadmap items out of TODO tracking and recorded them in feature notes (2026-02-08).
Latest sync: enhanced PQS pivot sampling with `id`-range selection (avoids `ORDER BY RAND()`), added basic two-table `JOIN ... USING (id)` pivots with alias-aware matching, switched containment checks to `LIMIT 1` existence probes, and enabled a default PQS oracle weight (2026-02-08).
Latest sync: added PQS v1 oracle (single-table pivot selection, equality/IS NULL predicates, containment check), wired weights/overrides/config, and expanded unit tests (2026-02-08).
Latest sync: hardened compute worker webpack replacement plugin resolution so CI tests do not fail when `NormalModuleReplacementPlugin` is missing from the bundled webpack export (2026-02-09).
Latest sync: replaced the `JSX.Element` type alias in the report page with `ReactNode` to avoid missing JSX namespace errors during Next.js builds (2026-02-09).
Latest sync: switched the report diff viewer `compareMethod` to use `DiffMethod.WORDS_WITH_SPACE` for type-safe builds (2026-02-09).
Latest sync: updated the remaining report diff viewer `compareMethod` usage to `DiffMethod.WORDS_WITH_SPACE` for type-safe builds (2026-02-09).
Latest sync: configured Next.js alias/extension alias to map `computeWorker.ts` to the shipped `computeWorker.js` and updated the worker verification script for the web report build (2026-02-09).
Latest sync: guarded `next build` behind a release flag and added a `build:release` script so local defaults use `next dev` (2026-02-09).
Latest sync: switched the default `next dev` script to `--turbo` and added `dev:webpack` for a webpack fallback (2026-02-09).
Latest sync: vendored `react-diff-viewer-continued` compute worker implementation to break the worker/compute-lines cycle while keeping Worker execution, and aliased Next.js to the local compute-lines module (2026-02-09).
Latest sync: CI now verifies the web worker alias config and runs a release web build via `SHIRO_RELEASE=1` to exercise the optimized build path (2026-02-09).
Latest sync: next config now loads webpack via Next's bundled webpack fallback so the worker config test runs in CI without a direct webpack dependency (2026-02-09).
Latest sync: turbopack aliases now include relative compute-lines/computeWorker specifiers to avoid resolution failures with relative worker imports (2026-02-09).
Latest sync: documented web worker override upgrade guidance in `docs/notes/feature.md` (2026-02-09).
Latest sync: adjusted flaky errno test assertions to use non-fatal checks (2026-02-09).
Latest sync: fixed lints for worker sync HTTP response close path (`bodyclose`) and case-archive exported constant comments (`revive`) (2026-02-08).
Latest sync: addressed PR #78 security/reliability findings for Worker auth defaults/body limits/download URL handling and `shiro-report` artifact URL generation (2026-02-07).
Latest sync: cleaned lint-only `ineffassign` findings in GroundTruth query picking and runner DSG mismatch label extraction (2026-02-07).
Latest sync: completed PR-77 follow-ups for alias rendering, nested-query scope enforcement (with strict empty-column-set checks), and FULL JOIN emulation USING anti-filter scope compatibility; added generator/oracle regression tests (2026-02-07).
Latest sync: Impo seed guardrail now preserves the last concrete skip reason, and minimize now requires base replay reproducibility before reduction (non-reproducible cases are tagged flaky with explicit reason fields); added runner/oracle regression tests (2026-02-07).
Latest sync: SelectQueryBuilder now reuses query analysis for constraint checks to avoid redundant AST walks (2026-02-08).
Latest sync: runner oracle overrides now use data-driven profiles for consistent capability gating (2026-02-08).
Latest sync: QuerySpec now accepts oracle profiles to derive generator constraints from the same capability gating (2026-02-08).
Latest sync: renamed oracle profile types/helpers to avoid revive stutter warnings (2026-02-08).
Latest sync: NoREC profile disables set operations and added regression coverage for profile constraint mapping and analysis refresh (2026-02-08).
Latest sync: profile constraints no longer relax subquery bans, CERT/CODDTest builder setup is deduped, and runner override tests cover AllowSubquery/JoinUsingProbMin (2026-02-08).
Latest sync: minimizer now uses strategy-based multi-pass reduction (error-case vs replay-spec) with validated insert merge and weighted candidate selection to improve minimization depth and stability; added runner tests (2026-02-08).
Latest sync: SelectQueryBuilder now skips full feature analysis for join-only constraints and reuses cached determinism metadata when present (2026-02-08).
Latest sync: SelectQueryBuilder now invalidates cached analysis after predicate attachment to keep determinism checks accurate (2026-02-08).
Latest sync: minimizer lint cleanup for revive (named returns + unused param removal) (2026-02-08).
Latest sync: centralized minimizer default rounds into a shared constant to avoid divergent reducer defaults (2026-02-08).

## Generator / Oracles

1. DQP: expand plan-hint coverage and add optimizer variables if needed. (Added SET_VAR hints for tidb_enable_outer_join_reorder and tidb_enable_inl_join_inner_multi_pattern.)
2. Refactor per-oracle generator overrides into data-driven capability profiles to reduce duplicated toggles. (done)
3. Roll out `set_operations` / `derived_tables` / `quantified_subqueries` with profile-based oracle gating and observability before default enablement. (done: recursive QueryFeatures detection + runner interval counters/ratios + regression tests)
4. Extend grouping support from `WITH ROLLUP` to `GROUPING SETS` / `CUBE` with profile-based fallback for unsupported dialects. (done: SQL builder + generator mode selection + config/profile wiring + regression tests)
5. Validate GroundTruth DSG skip-rate changes after the `tN -> k(N-1)` alignment fix and decide whether additional DSG precheck constraints are still needed. (done: added DSG-valid edge-set preference + retry bump and revalidated skip behavior)

## Reporting / Aggregation

1. Add index writer sharding and optional gzip support for CDN/S3.
2. Consider column-aware EXPLAIN diff once table parsing stabilizes.
3. Report summaries now expose `error_reason`, `bug_hint`, `error_sql`, and `replay_sql` for indexing. (done)
4. Review follow-up: `sqlErrorReason(nil)` now returns empty reason and EET ORDER BY drop path is documented. (done)
5. Report summary now includes `minimize_status` and emits early case-allocation logs to improve logs/reports correlation. (done)
6. Minimize status flow now has explicit `interrupted` fallback when execution exits while minimize is in progress. (done)
7. Minimize now prechecks base replay reproducibility and marks non-reproducible cases as `flaky` with explicit `minimize_reason` / `flaky_reason` metadata. (done)
8. Cloudflare metadata plane follow-up: add explicit audit trail (who/when/what) for metadata PATCH and sync operations.
9. Frontend UX: waterfall/list switch, direct archive/report links, Worker download API integration, and native label/issue editing controls are done. (done)
10. AI search: Worker now supports per-case similar lookup with optional AI summary; next step is adding vector-style embedding retrieval/rerank once case text fields are normalized.
11. Frontend CI now runs compile/lint/test in a dedicated workflow job; consider adding end-to-end smoke checks against a fixture `reports.json` payload.
12. Serve the report UI directly from Worker assets for single-domain deployment. (done)
13. Configure Worker observability settings in wrangler.jsonc. (done)

## Coverage / Guidance

1. Centralize tuning knobs for template sampling weights and QPG template overrides (enable prob/weights/TTLs/thresholds). (done: template join strategy weights and `qpg.template_override` thresholds/weights/probability/TTL are config-driven)

## Architecture / Refactor

1. Add an adaptive feature capability model (SQLancer++ style) to learn DBMS support and auto-tune generator/oracle gating.
2. Centralize query feature analysis + EXPLAIN parsing to avoid duplicated AST walks and plan parsing (shared by QPG/DQP/CERT/report).
3. Add KQE-lite join-graph coverage guidance to bias join generation toward under-covered structures.
4. Unify expression rewrite/mutation registries for EET/CODDTest/Impo with shared type inference and NULL-safety policies.
5. Refine type compatibility and implicit cast rules using SQL standard guidance to reduce benign type errors.

## Fuzz Efficiency Refactor Plan

1. Introduce a `QueryAnalysis` struct in `internal/generator` that captures deterministic/aggregate/window/subquery/limit/group-by/order-by flags, join counts/signatures, predicate stats, and subquery allowance plus disallow reasons. Compute it once in `GenerateSelectQuery` and attach it to `Generator.LastFeatures`. (done for core flags; predicate stats/disallow reasons remain on QueryFeatures)
2. Replace duplicated query walkers in `internal/oracle/sql.go` (e.g., `queryDeterministic`, `queryHasSubquery`, `queryHasAggregate`, `queryHasWindow`) with the `QueryAnalysis` fields when the query is generator-produced. Keep lightweight helpers only for SQL-only paths. (done for core helpers)
3. Define `OracleSpec` or `QuerySpec` (generator constraints + predicate policy) and extend `SelectQueryBuilder` to build queries that satisfy these constraints up front. Move oracle guardrails (limit/window/nondeterministic/predicate guard/min join/require predicate match) from oracle `Run` methods into specs. (done for core oracles, including NoREC guardrails via `QueryGuardReason` and builder-level `DisallowSetOps`)
4. Replace `internal/runner/runner_oracle_overrides.go` hard-coded toggles with data-driven capability profiles (e.g., `Profile` map). Profiles should include feature toggles, predicate mode, join policy, min join tables, and subquery allowances, then apply a single profile per oracle. (done)
5. Reduce TiDB parser overhead in `observeSQL` by adding a keyword fast-path and allowing precomputed analysis from generator/oracle paths (fast-path done). Added a tiny LRU cache for repeated SQL parse results.
6. Validation: update tests for builder/spec equivalence and ensure oracle semantics remain unchanged; run targeted oracle/generator tests to confirm skip reduction and coverage stability.
