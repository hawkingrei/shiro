# Keep It Simple: Testing Databases via Differential Query Plans (DQP)

## 问题背景
优化器存在多种执行计划选择路径，传统的等价查询测试需要复杂的重写规则且覆盖有限。若能让同一查询在不同计划下执行并对比结果，就能更直接地暴露优化器相关的逻辑错误。

## 核心思路
DQP 通过“同一查询、多种执行计划”的差分测试作为 oracle。借助优化器提示（hint）或会话变量，强制生成不同计划，然后比较执行结果是否一致。

## 关键机制
1. 生成查询 Q。
2. 通过 hint 或 session 变量构造多个计划变体 Q1, Q2, ...
3. 执行各变体并对比结果签名或行集；不一致即为 bug。

## Oracle 形式
- Q: SELECT ...
- Q1: SELECT /*+ hintA */ ...
- Q2: SELECT /*+ hintB */ ...
- 若结果不一致，则说明不同计划对语义解释不一致。

## 适用范围与限制
- 需要数据库支持计划提示或可控的优化器开关。
- 为避免无关噪声，通常限制 hint 数量并保持语义不变。
- 某些变体可能触发不同的物理执行路径，需确保结果比较稳定。

## 价值与影响
DQP 以最小的查询改动触发计划分歧，是发现优化器逻辑错误的高效方式，尤其适合计划选择与算子实现相关的 bug。
