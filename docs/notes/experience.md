# Experience Notes

- Implemented core fuzzing pipeline, oracles, plan replayer capture, and reporting.
- Added window functions, correlated subqueries, subquery depth guard, and DQP hints/variables.
- Added local case artifacts and optional S3 upload interface; inserts are recorded for reproduction.
- Plan replayer is hardcoded to `PLAN REPLAYER DUMP EXPLAIN`.
- Added predicate generation for EXISTS/IN and NOT EXISTS/NOT IN (including literal lists).
- Added config flags/weights for NOT EXISTS/NOT IN frequency.
- Added a static report renderer (`cmd/shiro-report`) for aggregating cases from local or S3 into an HTML view.
- Reworked report renderer to output `report.json` and added a Next.js frontend in `web/` for GitHub Pages/Vercel.
- Report output uses UUIDv7-based case directories to avoid collisions across concurrent Shiro runs.
- Added Query Plan Guidance (QPG): plan signature tracking via EXPLAIN with plan-diversity mutations.
- QPG now parses plan nodes (operator + depth) to track operator/shape coverage and guides join/agg/subquery weights.
- QPG adds a short-term EXPLAIN cache and shape-stall heuristic to avoid repeated plan collection.
- QPG parses JSON-format EXPLAIN and tracks join-order diversity for weight boosts.
- QPG tracks operator-sequence signatures and uses them to boost agg/subquery weights when operator coverage stalls.
- QPG JSON parsing now accepts either "id" or "operator" keys with normalization.
- QPG normalizes EXPLAIN plan text to reduce noisy plan signature variance (table/column/index tokens).
- Report summaries now record `plan_signature` (QPG EXPLAIN hash) for filtering in the frontend.
- Added `plan_signature_format` (plain/json) to report summaries and UI filters.
- QPG coexists with bandits: bandit weights apply first, QPG can temporarily override join/subquery/agg when plan coverage stalls.
- Stdout logging minimized; detailed metrics are emitted to `logs/shiro.log` with top-N summaries.
- Oracle-specific generator overrides are applied per run (e.g., GroundTruth inner joins without predicates, Impo without scalar subqueries).
- CTE column metadata now follows SELECT aliases (c0/c1/...), avoiding unknown-column join errors.
- Aggregation SELECT lists include group keys to satisfy ONLY_FULL_GROUP_BY.
- CERT error samples are logged to aid debugging EXPLAIN failures.
- `PLAN REPLAYER DUMP` output may include URL or only a zip name; URL parsing must be tolerant of trailing punctuation.
- Using `EXPLAIN` in replayer avoids executing the buggy SQL again during dump.
- Tracking inserts in-memory provides a lightweight reproduction script without exporting full data dumps.
- TLP oracle must compare against the base query without the predicate; otherwise false positives occur.
- CODDTest mappings are sensitive to float formatting; preserving raw string literals avoids rounding mismatches.
- Suppressing whitelist logs unless verbose keeps non-verbose runs clean.
- join_type_seq / join_graph_sig logging can explode; keep stdout minimal and detail log to top-N summaries to avoid log bloat.
- TQS alignment: random-walk history graph (H) with coverage-driven edges and gamma controls join-table selection in DSG mode.
- DSG join generation constraints: only same-name k columns; t0 should be base; ON 1=1 removed; CROSS JOIN is rare.
- CREATE VIEW should not strip WITH if the query references CTEs; regenerate without CTE or keep WITH.
- Avoid ORDER BY numeric literals (TiDB treats them as column positions).
- CODDTest requires careful NULL handling; current guard only enables when relevant columns have no NULLs, but some CODDTest cases still trigger.
- TLP still produces occasional mismatches even after skipping subqueries/aggregates/non-deterministic predicates.
- Plan replayer tokens already include `.zip` in TiDB master; when using a template ending in `.zip`, avoid double suffix.
- Replayer download should fall back to `@@tidb_last_plan_replayer_token` when dump output lacks URL.
- Feature-level bandit adaptation needs to set generator weights per-query and clear them after the query finishes.
- Further reducing CODDTest/TLP false positives required limiting to simple predicates (AND of comparisons) and deterministic, non-subquery expressions.
- Plan cache in TiDB master does not appear to cache CTE-based PREPARE statements; plan-cache-only mode skips CTEs.
- Plan-cache sequence must run EXECUTE immediately before `SHOW WARNINGS`; otherwise warnings belong to the last `SELECT @@last_plan_from_cache`.
- For plan cache checks: run the target statement, then `SELECT @@last_plan_from_cache`, then re-run the target statement and `SHOW WARNINGS` so warnings are bound to the target SQL (not the `SELECT`). Avoid consecutive `SHOW WARNINGS` and `SELECT @@last_plan_from_cache` without an intervening EXECUTE.
- Prepared plan cache oracle compares a literal-SQL baseline signature against a prepared execution; treat mismatches as bugs when cache hit or when miss has no warnings.
- Non-prepared plan cache: a miss without warnings can be normal; only treat result-signature mismatches as bugs.
- DQP hint generation should stay minimal: pick a small number of hints per query (0-2), avoid stacking ON/OFF pairs, and keep ordering predictable.
- Code style: keep changes simple and readable; follow the Uber Go Style Guide for formatting and naming.
- `EXPLAIN FOR CONNECTION` and `@@last_plan_from_cache` must be queried right after the target EXECUTE to avoid interleaving effects.
- Go mysql driver can emit `busy buffer` if result sets are not fully drained; ensure rows are consumed before closing statement/connection.
- Reports now emit `origin_result` from the second EXECUTE (signature + sample rows) to anchor prepared vs. original comparisons.
- Prepared SQL in reports must use `SET @pN=...` + `EXECUTE ... USING @pN` form; limit PREPARE parameters to <= 8.
- SQL error handling uses a hardcoded whitelist (e.g., 1064) as fuzz-tool faults; non-whitelisted MySQL errors are treated as bugs.
- Impo base query errors that mention `_tidb_rowid` should be captured as bug cases (plan replayer + report), not skipped.
- Errors containing "Can't find column ... in schema Column" should be treated as bugs and reported.
- Impo runs can yield `cmp=incomparable` for upper mutations (e.g., FixMCmpOpU/FixMWhere1U on GROUP BY queries). Treat these as oracle comparison limitations, not engine bugs, unless full result comparison confirms containment is violated.
- When creating PRs via `gh`, use a heredoc or multi-line `--body` to avoid literal `\n` in the description.
- If Go version is 1.21 or newer, prefer built-in `max`/`min` instead of custom helpers to reduce utility clutter.
- If fuzzing runs show a sudden spike of errors across multiple oracles, confirm the DB service uptime before diagnosing a code regression.
- GroundTruth now supports exact multiplicity counting for DSG joins (INNER/LEFT/RIGHT/SEMI/ANTI/CROSS) with per-table and join caps; bitmap path remains INNER-only for non-DSG.
- Report output is stabilized by sorting table dumps and emitting deterministic `details` JSON in `summary.json`.
- SQL validity logs now include ratio and invalid counts to reduce ambiguity in interval stats.
- `dynamic_state.json` is reserved for runtime parameter reuse across restarts; avoid observability-only fields there.
- "Can't find column ... in schema Column" in NoREC reports indicates an engine bug and should be recorded as a case.
- Centralized oracle query constraints via SelectQueryBuilder and surfaced builder failure reasons in skip metrics.
- DSG join alignment: prefer k0 or k{idx} keys with same-name joins to reduce ground-truth key mismatches.
- GroundTruth edge extraction now tolerates AND-wrapped join conditions and USING with multiple columns (first key only).
- CERT now retries generation to satisfy min base rows and can fall back to a base query without WHERE when needed.
